name: BUILD

on:
  workflow_dispatch:
    inputs:
      AWS_ENV:
        description: ë°°í¬ í™˜ê²½
        required: true
        type: choice
        options:
          - ê°œë°œ
          - ê²€ì¦
          - ìƒìš©
          
      

jobs:
  # ìž‘ì—… ì´ë¦„ ì •ì˜
  build:
    # runnerê°€ ì‹¤í–‰ë  í™˜ê²½ì„ ì„¤ì •í•©ë‹ˆë‹¤.
    runs-on: ubuntu-latest
    steps:
      - name: Set environment variables
        id: init_env
        run: |
          if [ "${{ github.event.inputs.AWS_ENV }}" = "ìƒìš©" ]; then
            echo "BUILD_COMMAND=build:prod" >> $GITHUB_ENV
            echo "AWS_ACCESS_KEY=${{ secrets.PR_AWS_ACCESS_KEY }}" >> $GITHUB_ENV
            echo "AWS_PRIVATE_KEY=${{ secrets.PR_AWS_PRIVATE_KEY }}" >> $GITHUB_ENV
            echo "S3_BINARY_BUCKET=polink-production-provisional-data" >> $GITHUB_ENV
            echo "S3_BINARY_PATH=deployment/BERLIN/binary" >> $GITHUB_ENV
          elif [ "${{ github.event.inputs.AWS_ENV }}" = "ê²€ì¦" ]; then
            echo "BUILD_COMMAND=build:staging" >> $GITHUB_ENV
            echo "AWS_ACCESS_KEY=${{ secrets.VF_AWS_ACCESS_KEY }}" >> $GITHUB_ENV
            echo "AWS_PRIVATE_KEY=${{ secrets.VF_AWS_PRIVATE_KEY }}" >> $GITHUB_ENV
            echo "S3_BINARY_BUCKET=vf-ca-provisional-data" >> $GITHUB_ENV
            echo "S3_BINARY_PATH=deployment/BERLIN/binary" >> $GITHUB_ENV
          elif [ "${{ github.event.inputs.AWS_ENV }}" = "ê°œë°œ" ]; then
            echo "BUILD_COMMAND=build:staging" >> $GITHUB_ENV
            echo "AWS_ACCESS_KEY=${{ secrets.TB_AWS_ACCESS_KEY }}" >> $GITHUB_ENV
            echo "AWS_PRIVATE_KEY=${{ secrets.TB_AWS_PRIVATE_KEY }}" >> $GITHUB_ENV
            echo "S3_BINARY_BUCKET=pcloud-testbed-provisional-data" >> $GITHUB_ENV
            echo "S3_BINARY_PATH=deployment/BERLIN/binary" >> $GITHUB_ENV
          fi

      # ê¹ƒ ë¹Œë“œ ë²ˆí˜¸ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
      - name: Set custom environment variables
        run: |
          echo "GITHUB_REPO=$(echo $GITHUB_REPOSITORY | awk -F'/' '{print $2}')" >> $GITHUB_ENV
          echo "BUILD_NO=${GITHUB_SHA::10}" >> $GITHUB_ENV

          
      # ë ˆí¬ì§€í† ë¦¬ ì½”ë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
      - name: Checkout code
        uses: actions/checkout@v3

      # Node.js í™˜ê²½ì„ ì„¤ì •í•©ë‹ˆë‹¤.
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'yarn' # yarn ìºì‹œ í™œì„±í™”

      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "dir=$(yarn cache dir)" >> $GITHUB_OUTPUT

      # yarn ìºì‹œ ë° node_modules ìºì‹œ ë³µì›
      - uses: actions/cache@v4
        id: yarn-cache # use this to check for `cache-hit` (`steps.yarn-cache.outputs.cache-hit != 'true'`)
        with:
          path: |
            ${{ steps.yarn-cache-dir-path.outputs.dir }}
            **/node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      # í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: yarn install --frozen-lockfile

      # í”„ë¡œì íŠ¸ ë¹Œë“œ ì‹¤í–‰
      # CI falseë¥¼ í•˜ì§€ ì•Šìœ¼ë©´ warningì˜ ê²½ìš°ì— ì—ëŸ¬ë¥¼ ë˜ì§€ê¸° ë•Œë¬¸ì— í•„ìˆ˜!
      - name: Build
        run: |
          echo "Running build command: ${{ env.BUILD_COMMAND }}"
          CI=false yarn run ${{ env.BUILD_COMMAND }}

      # AWS ì¸ì¦ ì •ë³´ ì„¤ì •
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ env.AWS_PRIVATE_KEY }}
          aws-region: us-west-1

      # ë¹Œë“œ ê²°ê³¼ë¬¼ S3 ì—…ë¡œë“œ (ë°”ì´ë„ˆë¦¬ íŒŒì¼ëª… : ê¹ƒ ë ˆí¬ì§€í† ë¦¬ëª…-ë¹Œë“œë²ˆí˜¸
      - name: Deploy to S3
        run: |
          aws s3 cp --recursive ./build s3://${{ env.S3_BINARY_BUCKET }}/${{ env.S3_BINARY_PATH }}/${{ env.GITHUB_REPO }}-${{ env.BUILD_NO }}/ 

      # âœ… ë¹Œë“œ ìš”ì•½ Summary ì¶œë ¥
      - name: Show Summary
        run: |
          echo "## âœ… Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ë°°í¬ í™˜ê²½:** ${{ github.event.inputs.AWS_ENV }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¹Œë“œ ëª…ë ¹:** ${{ env.BUILD_COMMAND }}" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 ë²„í‚·:** ${{ env.S3_BINARY_BUCKET }}" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 ê²½ë¡œ:** s3://${{ env.S3_BINARY_BUCKET }}/${{ env.S3_BINARY_PATH }}/${{ env.GITHUB_REPO }}-${{ env.BUILD_NO }}/" >> $GITHUB_STEP_SUMMARY
          echo "- **ë°°í¬ ë°”ì´ë„ˆë¦¬ëª…:** ${{ env.GITHUB_REPO }}-${{ env.BUILD_NO }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ ë¹Œë“œ ë° ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!" >> $GITHUB_STEP_SUMMARY
