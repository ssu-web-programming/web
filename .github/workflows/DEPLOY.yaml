name: DEPLOY

on:
  workflow_dispatch:
    inputs:
      AWS_ENV:
        description: ë°°í¬ í™˜ê²½
        required: true
        type: choice
        options:
          - ê°œë°œ
          - ê²€ì¦
          - ìƒìš©
      AWS_DEPLOY_BINARY:
        required: true
        type: string



jobs:
  # ìž‘ì—… ì´ë¦„ ì •ì˜
  deploy:
    # runnerê°€ ì‹¤í–‰ë  í™˜ê²½ì„ ì„¤ì •í•©ë‹ˆë‹¤.
    runs-on: ubuntu-latest
    steps:
      - name: Set environment variables
        id: init_env
        run: |
          if [ "${{ github.event.inputs.AWS_ENV }}" = "ìƒìš©" ]; then
            echo "AWS_ACCESS_KEY=${{ secrets.PR_AWS_ACCESS_KEY }}" >> $GITHUB_ENV
            echo "AWS_PRIVATE_KEY=${{ secrets.PR_AWS_PRIVATE_KEY }}" >> $GITHUB_ENV
            echo "S3_BINARY_BUCKET=polink-production-provisional-data" >> $GITHUB_ENV
            echo "S3_BINARY_PATH=deployment/BERLIN/binary" >> $GITHUB_ENV
            echo "S3_DEPLOY_BUCKET=pr-po-ai-frontend-static-s3" >> $GITHUB_ENV
            echo "CLOUDFRONT_DISTRIBUTION_ID=E3JZ4I6ZJCIMNN" >> $GITHUB_ENV
          elif [ "${{ github.event.inputs.AWS_ENV }}" = "ê²€ì¦" ]; then
            echo "AWS_ACCESS_KEY=${{ secrets.VF_AWS_ACCESS_KEY }}" >> $GITHUB_ENV
            echo "AWS_PRIVATE_KEY=${{ secrets.VF_AWS_PRIVATE_KEY }}" >> $GITHUB_ENV
            echo "S3_BINARY_BUCKET=vf-ca-provisional-data" >> $GITHUB_ENV
            echo "S3_BINARY_PATH=deployment/BERLIN/binary" >> $GITHUB_ENV
            echo "S3_DEPLOY_BUCKET=vf-po-ai-frontend-static-s3" >> $GITHUB_ENV
            echo "CLOUDFRONT_DISTRIBUTION_ID=E2PX7B1ISOYX5L" >> $GITHUB_ENV
          elif [ "${{ github.event.inputs.AWS_ENV }}" = "ê°œë°œ" ]; then
            echo "AWS_ACCESS_KEY=${{ secrets.TB_AWS_ACCESS_KEY }}" >> $GITHUB_ENV
            echo "AWS_PRIVATE_KEY=${{ secrets.TB_AWS_PRIVATE_KEY }}" >> $GITHUB_ENV
            echo "S3_BINARY_BUCKET=pcloud-testbed-provisional-data" >> $GITHUB_ENV
            echo "S3_BINARY_PATH=deployment/BERLIN/binary" >> $GITHUB_ENV
            echo "S3_DEPLOY_BUCKET=tb-po-ai-frontend-static" >> $GITHUB_ENV
            echo "CLOUDFRONT_DISTRIBUTION_ID=EBA1RV7VCJAN0" >> $GITHUB_ENV
          fi

      # AWS ì¸ì¦ ì •ë³´ ì„¤ì •
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ env.AWS_PRIVATE_KEY }}
          aws-region: ap-northeast-2

      # ë°°í¬í•  ë°”ì´ë„ˆë¦¬ S3ì—ì„œ ë‹¤ìš´ë¡œë“œ
      - name: Download binary file from S3
        run: |
          mkdir -p /tmp/deploy-artifact
          aws s3 cp --recursive \
            "s3://${{ env.S3_BINARY_BUCKET }}/${{ env.S3_BINARY_PATH }}/${{ inputs.AWS_DEPLOY_BINARY }}" \
            /tmp/deploy-artifact/${{ inputs.AWS_DEPLOY_BINARY }} \
            --region us-west-1

      # S3ì— ë¹Œë“œ ê²°ê³¼ë¬¼ ë°°í¬
      # dist í´ë” ë‚´ìš©ì„ S3 ë²„í‚·ì— ë™ê¸°í™”, --delete ì˜µì…˜ìœ¼ë¡œ ë²„í‚·ì— ìžˆëŠ” ì´ì „ íŒŒì¼ ì‚­ì œ
      - name: Deploy to S3
        run: |
          aws s3 sync /tmp/deploy-artifact/${{ inputs.AWS_DEPLOY_BINARY }} \
          s3://${{ env.S3_DEPLOY_BUCKET }}/ \
          --region ap-northeast-2

      # CloudFront ìºì‹œ ë¬´íš¨í™”
      - name: Invalidate CloudFront Cache
        run: aws cloudfront create-invalidation --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"

      # âœ… ë¹Œë“œ ë° ë°°í¬ ê²°ê³¼ ìš”ì•½ ì¶œë ¥
      - name: Summary
        run: |
          echo "## âœ… ë°°í¬ Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ë°°í¬ í™˜ê²½:** ${{ github.event.inputs.AWS_ENV }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë°°í¬ ë°”ì´ë„ˆë¦¬ëª…:** ${{ github.event.inputs.AWS_DEPLOY_BINARY }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë°°í¬ S3 ë²„í‚· ê²½ë¡œ :** s3://${{ env.S3_DEPLOY_BUCKET }}/" >> $GITHUB_STEP_SUMMARY
          echo "- **CloudFront ID :** ${{ env.CLOUDFRONT_DISTRIBUTION_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!" >> $GITHUB_STEP_SUMMARY
